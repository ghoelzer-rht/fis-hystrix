:noaudio:
:scrollbar:
:data-uri:
:toc2:

== Lab Guide - Deploying a Microservice Gateway using Kubeflix & Hysterix

In this lab, we will create a Gateway Microservice Pattern implementation of a simple Dictionary Definition service using the Kubeflix API Implementation for Service Discovery and Routing.  Additionally, we will use Hysterix for Microservice monitoring and implementation of a Circuit Breaker pattern.  The Microservice implementations are using Red Hat Fuse Integration Services (FIS) 2.0, and use relatively simple REST and Java DSL, along with Java POJO and Service implementations.  FIS 2.0 is an integrated Java Framework that's highly suitable for Microservice implementations, and focused on real-time/event-driven integration patterns.  For more background on all the FIS 2.0 capabilities see - https://developers.redhat.com/blog/2017/02/21/announcing-fuse-for-agile-integration-on-the-cloud-fis-2-0-release/

*Fork/Clone this Repo into a local working directory to complete the Lab Exercises*

:numbered:

== Deploy Base Microservices to OpenShift

1. Login to the remote OpenShift environment (Get instructions from your OpenShift admin)

1. Create a new project with a unique name or ensure an existing OpenShift project is selected 
+
    oc new-project fis-hysterix-<unique number>
    or
    oc project <your-project-name>

1. From the base of where you cloned your git repo, execute the following commands:
+
[source,bash]
----
oc process -f support/templates/gateway.json | oc create -f-

oc process -f support/templates/definition.json | oc create -f-
----
+
From the OpenShift Web Console, select the project you have created or are using.  You should see that two s2i builds have kicked-off for the *gateway* and *definition components*, which will deploy when complete as shown below:
+
image::https://github.com/ghoelzer-rht/fis-hystrix/blob/master/images/fis-lab-deployment1.png[]
+

Expand the *gateway* microservice deployment, and click/select the created Route.  This should open a Swagger UI/API Explorer for the deployed *definition* microservice, verify the operation of the definition API as shown below:
+
image::https://github.com/ghoelzer-rht/fis-hystrix/blob/master/images/fis-lab-deployment2.png[]

== Implement Hysterix Dashboard and Turbine Server
Now letâ€™s add the Hysterix Dashboard and Turbine Server components to monitor the gateway and definition microservices within our project.

1. Back at the command line, navigate to the root of the git project and execute the following *oc* command:
+
[source,bash]
----
oc process -f support/templates/kubeflix.json | oc create -f-
----
+
You should now see these components deployed and running in your project after the supporting Container Images were successfully pulled as shown below:
+
image::https://github.com/ghoelzer-rht/fis-hystrix/blob/master/images/fis-lab-hystrix1.png[]

1. Open the Hysterix Dashboard and generate some API activity using the Swagger API Console.  Start by opening browser tab at the hystrix-dashboard Route Http Endpoint as show below:
+
image::https://github.com/ghoelzer-rht/fis-hystrix/blob/master/images/fis-lab-turbine1.png[]
+
Click the Monitor Stream button to display the Dashboard and hit the definition API a bunch of times from the Swagger API Console and you should see something like what is displayed below:
+
image::https://github.com/ghoelzer-rht/fis-hystrix/blob/master/images/fis-lab-dashboard1.png[]
+
Now let's try out the *circuit breaker* for the *definition* API.  Go back to the definition deployment within the Web Console, expand the view, and on the diplayed pod, click the down arrow scaling it to *Zero* pods as shown below:
+
image::https://github.com/ghoelzer-rht/fis-hystrix/blob/master/images/fis-lab-hystrix2.png[]
+
Now hit the definition API a bunch of times from the Swagger API Console and you should see now see that the circuit breaker has *closed* due to the number of failures of the definition API as displayed below:
+
image::https://github.com/ghoelzer-rht/fis-hystrix/blob/master/images/fis-lab-dashboard2.png[]
+
Go back to the definition deployment within the Web Console and on the diplayed pod, click the up arrow scaling it to *One*.  After the definition Pod Health Check succeeds, hit the definition API a bunch of times from the Swagger API Console.  You should see that the circuit breaker is now *open* again and successful responses are returned.


